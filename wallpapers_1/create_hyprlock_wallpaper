#!/usr/bin/env python3

import os
import subprocess
import sys

IMG_W = 1920
IMG_H = 1080
BLUR_W = 800
BLUR_H = 600
RADIUS = 50
BLUR_SIGMA = 20


def derive_output_path(input_path: str) -> str:
    """Generate output path: input_blurred.ext"""
    dirname = os.path.dirname(input_path)
    basename = os.path.basename(input_path)
    name_part = os.path.splitext(basename)[0]
    return os.path.join(dirname, f"{name_part}_blurred.png")


def main():
    if len(sys.argv) < 2:
        print("Usage: python3 blur_center.py <input_file> [output_file]")
        print("  input_file   : Path to input image")
        print("  output_file  : (Optional) Output path. Default: <input>_blurred.png")
        sys.exit(1)

    input_file = sys.argv[1]

    if not os.path.isfile(input_file):
        print(f"Error: Input file '{input_file}' does not exist.", file=sys.stderr)
        sys.exit(1)

    output_file = sys.argv[2] if len(sys.argv) >= 3 else derive_output_path(input_file)

    x = (IMG_W - BLUR_W) // 2
    y = (IMG_H - BLUR_H) // 2

    # fmt: off
    cmd = [
        "magick", input_file,
        "-filter",
        "Lanczos", "-resize", f"{IMG_W}x{IMG_H}^",
        "(",
            "+clone", "-crop", f"{BLUR_W}x{BLUR_H}+{x}+{y}", "+repage", "-blur", f"0x{BLUR_SIGMA}",
                "(",
                    "-size", f"{BLUR_W}x{BLUR_H}", "xc:black", "-fill", "white", 
                    "-draw", f"roundrectangle 0,0 {BLUR_W - 1},{BLUR_H - 1} {RADIUS},{RADIUS}",
                    "-morphology", "erode", "disk:2",
                ")",
            "-alpha", "off", "-compose", "copy_opacity", "-composite",
        ")", 
        "-geometry", f"+{x}+{y}",
        "-compose", "over", "-composite",
        output_file,
    ]
    # fmt: on

    try:
        # Run the command
        _ = subprocess.run(cmd, check=True, capture_output=True, text=True)
        print(f"✅ Processed: '{input_file}' → '{output_file}'")
    except subprocess.CalledProcessError as e:
        print(f"❌ ImageMagick failed with return code {e.returncode}", file=sys.stderr)
        print(f"Command: {' '.join(cmd)}", file=sys.stderr)
        print(f"stderr: {e.stderr or ''}", file=sys.stderr)
        sys.exit(1)
    except FileNotFoundError:
        print(
            "❌ 'magick' command not found. Please install ImageMagick 7+.",
            file=sys.stderr,
        )
        sys.exit(1)


if __name__ == "__main__":
    main()
